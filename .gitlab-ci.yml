image: 172.16.1.99/transwarp/product_meta_builder:tdc-1.0
before_script:
    - source /etc/profile
    - source /root/.bashrc
    - export PUB_HARBOR=172.16.1.99
    - export PUB_MAJOR_VERSION=tdc-2.0

stages:
  - precommit_build
  - gold_build
  - to_github

precommit_build:
  stage: precommit_build
  script:
    - pip3 install -U -i http://172.16.1.161:30033/repository/pypi/simple/ --trusted-host=172.16.1.161 -r ./tests/py-requirements.txt
    - sh -e ./testing.sh
    - sh -e ./tests/precommit_validation.sh
  only:
    - /.*_master_\d+/
  tags:
    - k8s

gold_build:
  stage: gold_build
  script:
      - set -e
      - startdocker.sh &
      - sleep 90s
      - export PUB_PROJECT=gold
      - export PUB_TAG_MAJOR=$PUB_HARBOR/$PUB_PROJECT/product-meta:$PUB_MAJOR_VERSION
      - docker build --no-cache --force-rm -f Dockerfile -t $PUB_TAG_MAJOR .
      - docker push $PUB_TAG_MAJOR
      - ps aux | grep docker | grep -v "grep" |  awk '{print $2}' | xargs kill -9 || true
  only:
      - master@TDC/product-meta
  tags:
    - k8s

to_github:
  stage: to_github
  script:
      - set -e
      - export TRUNK=trunk
      - export SOURCE_BRANCH=master
      - export TARGET_BRANCH=master
      - git clone https://$GITHUB_USER:$GITHUB_TOKEN@github.com/WarpCloud/product-meta.git
      - cd product-meta
      - git remote add $TRUNK ssh://git@172.16.1.41:10022/TDC/product-meta.git
      - git merge --allow-unrelated-histories -s ours --no-commit $TRUNK/$SOURCE_BRANCH
      - for i in `cat .mirror`; do git checkout $TRUNK/$SOURCE_BRANCH -- $i; done
      - git add . && git commit -m "Mirror" && git push origin $TARGET_BRANCH
  only:
      - master@TDC/product-meta
  tags:
    - k8s
